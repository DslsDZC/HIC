<!--
SPDX-FileCopyrightText: 2026 * <dsls.dzc@gmail.com>

SPDX-License-Identifier: CC-BY-4.0
-->

# HIC内核代码组织结构

## 概述

HIC内核代码被清晰地分为两个独立的部分：
1. **架构相关代码** - 特定于CPU架构的实现
2. **架构无关代码** - 跨架构通用的核心逻辑

## 目录结构

```
kernel/
├── include/                  # 头文件
│   ├── arch.h              # 架构相关定义（仅架构特定代码使用）
│   ├── hal.h               # 硬件抽象层接口（核心代码使用）
│   ├── types.h             # 类型定义
│   ├── kernel.h            # 内核核心定义
│   ├── thread.h            # 线程管理
│   ├── domain.h            # 域管理
│   ├── capability.h        # 能力系统
│   ├── syscall.h           # 系统调用
│   ├── boot_info.h         # 启动信息
│   ├── build_config.h      # 构建配置
│   ├── irq.h               # 中断管理
│   └── pmm.h               # 物理内存管理
│
├── arch/                    # 架构相关代码（每个架构一个子目录）
│   └── x86_64/            # x86_64架构实现
│       ├── entry.S        # 内核入口点
│       ├── context.S      # 上下文切换
│       ├── gdt.c          # 全局描述符表
│       ├── gdt.h          # GDT头文件
│       ├── idt.c          # 中断描述符表
│       ├── idt.h          # IDT头文件
│       ├── idt.S          # IDT汇编存根
│       ├── asm.h          # 汇编接口
│       └── linker.ld      # 链接脚本
│
├── core/                    # 架构无关的核心代码
│   ├── main.c             # 内核主函数
│   ├── kernel_start.c     # 内核启动
│   ├── scheduler.c        # 调度器
│   ├── capability.c       # 能力系统
│   ├── domain.c           # 域管理
│   ├── syscall.c          # 系统调用处理
│   ├── irq.c              # 中断分发（架构无关）
│   ├── pmm.c              # 物理内存管理器
│   ├── module_loader.c    # 模块加载器
│   ├── hardware_probe.c   # 硬件探测（架构无关）
│   ├── hardware_probe.h   # 硬件探测接口
│   ├── boot_info.c        # 启动信息处理
│   ├── build_config.c     # 构建配置
│   └── formal_verification.c  # 形式化验证
│
└── lib/                     # 库代码（架构无关）
    ├── console.c          # 控制台驱动
    ├── console.h          # 控制台接口
    ├── mem.c              # 内存操作
    ├── mem.h              # 内存操作接口
    ├── string.c           # 字符串操作
    └── string.h           # 字符串操作接口
```

## 代码分层

### 第一层：架构相关代码 (`arch/`)

**目的**: 实现特定于CPU架构的功能

**包含内容**:
- 内核入口和启动代码
- 上下文切换汇编实现
- 内存管理单元初始化
- 中断控制器初始化
- GDT/IDT等架构特定数据结构
- 架构特定的汇编接口

**访问规则**:
- ✅ 可以包含 `include/arch.h`
- ✅ 可以使用架构特定的内联汇编
- ✅ 可以访问架构特定的寄存器
- ❌ 不应包含 `include/hal.h`
- ❌ 不应调用核心代码的函数

### 第二层：硬件抽象层 (`include/hal.h`)

**目的**: 提供统一的硬件访问接口

**包含内容**:
- 内存屏障接口
- 中断控制接口
- 时间戳接口
- 页操作接口
- 上下文切换接口
- 系统调用接口

**访问规则**:
- ✅ 由核心代码包含和使用
- ✅ 由架构相关代码实现
- ❌ 不应包含架构特定的宏或常量

### 第三层：架构无关核心代码 (`core/`)

**目的**: 实现内核的核心逻辑，不依赖具体架构

**包含内容**:
- 调度器
- 能力系统
- 域管理
- 系统调用处理
- 物理内存管理
- 模块加载器
- 硬件探测接口
- 形式化验证

**访问规则**:
- ✅ 必须包含 `include/hal.h`
- ✅ 必须通过HAL接口访问硬件
- ❌ 不应包含 `include/arch.h`
- ❌ 不应使用架构特定的汇编

### 第四层：库代码 (`lib/`)

**目的**: 提供通用的工具函数

**包含内容**:
- 字符串操作
- 内存操作
- 控制台输出

**访问规则**:
- ✅ 必须架构无关
- ✅ 只依赖基本类型
- ❌ 不应包含任何架构相关头文件

## 依赖关系

```
┌─────────────────────────────────────────┐
│     核心代码 (core/)                   │
│     包含 hal.h                          │
└─────────────────────────────────────────┘
              ↓ 调用
┌─────────────────────────────────────────┐
│     硬件抽象层 (hal.h)                  │
│     接口声明                             │
└─────────────────────────────────────────┘
              ↑ 实现
┌─────────────────────────────────────────┐
│     架构代码 (arch/)                    │
│     包含 arch.h                         │
└─────────────────────────────────────────┘
```

## 编译示例

### 编译x86_64架构
```bash
# 架构相关对象
arch/x86_64/entry.o
arch/x86_64/context.o
arch/x86_64/gdt.o
arch/x86_64/idt.o

# 核心对象
core/main.o
core/scheduler.o
core/capability.o
...

# 库对象
lib/console.o
lib/string.o
lib/mem.o

# 链接
x86_64-elf-ld -T arch/x86_64/linker.ld -o kernel.elf \
    arch/x86_64/*.o core/*.o lib/*.o
```

### 编译ARM64架构（未来）
```bash
# 架构相关对象
arch/arm64/entry.o
arch/arm64/context.o
arch/arm64/mmu.o
arch/arm64/gic.o

# 核心对象（与x86_64相同）
core/main.o
core/scheduler.o
core/capability.o
...

# 链接
aarch64-elf-ld -T arch/arm64/linker.ld -o kernel.elf \
    arch/arm64/*.o core/*.o lib/*.o
```

## 添加新架构的步骤

1. **创建架构目录**
   ```bash
   mkdir -p kernel/arch/<arch_name>
   ```

2. **实现架构特定文件**
   - `entry.S` - 内核入口
   - `context.S` - 上下文切换
   - 中断控制器初始化
   - 内存管理单元初始化
   - `linker.ld` - 链接脚本

3. **在 `include/arch.h` 中添加支持**
   - 添加架构类型枚举
   - 实现架构特定的内联函数
   - 定义架构特定的常量

4. **测试**
   - 确保核心代码无需修改即可在新架构上编译
   - 测试所有HAL接口的正确性

## 代码质量保证

### 架构相关代码
- ✅ 使用架构特定的优化
- ✅ 遵循架构的调用约定
- ✅ 正确处理架构特定的异常

### 架构无关代码
- ✅ 不包含任何架构特定的代码
- ✅ 通过HAL接口访问硬件
- ✅ 使用统一的数据结构
- ✅ 支持跨架构测试

## 注意事项

1. **严格的依赖关系**
   - 核心代码不能包含arch.h
   - 架构代码不能包含核心代码的头文件

2. **接口稳定性**
   - HAL接口保持稳定
   - 架构变化不影响核心代码

3. **性能考虑**
   - HAL使用内联函数，编译器会优化
   - 关键路径可使用架构特定优化

4. **文档要求**
   - 每个HAL接口都要有详细注释
   - 架构特定代码要说明实现细节

## 总结

通过这种清晰的分层结构，HIC内核实现了：
- **可移植性**: 核心代码可在不同架构间共享
- **可维护性**: 架构特定代码集中管理
- **可扩展性**: 容易添加新架构支持
- **代码复用**: 减少重复代码，提高开发效率