<!--
SPDX-FileCopyrightText: 2026 DslsDZC <dsls.dzc@gmail.com>

SPDX-License-Identifier: CC-BY-4.0
-->

# HIC架构可移植性设计文档

## 1. 设计理念：可移植性作为一等公民

HIC（分级隔离内核）架构将**可移植性**视为核心设计目标之一，而非事后补充特性。其设计哲学是：通过统一的架构范式，实现从嵌入式微控制器到数据中心服务器的**跨平台一致性**，同时允许在特定平台上进行深度优化。

## 2. 多层次硬件抽象体系

### 2.1 核心硬件抽象层（CHAL）

CHAL是位于Core-0与具体硬件之间的最小抽象层，仅提供架构必需的原子操作：

1. **内存管理原语**
   - 页表操作（创建、映射、权限设置）
   - TLB管理（刷新、无效化）
   - 物理内存分配器接口

2. **执行上下文管理**
   - 上下文保存/恢复原语
   - 特权级切换机制
   - 异常/中断栈帧布局

3. **原子与同步原语**
   - 内存屏障（全序、加载-存储、存储-存储）
   - 原子操作（CAS、LL/SC变体）
   - 自旋锁基础实现

CHAL的设计原则是“最小但完整”：每个接口都有明确的跨平台语义，但允许不同架构以最有效的方式实现。

---

#### 2.1.1 零开销抽象原则

CHAL的所有接口必须遵循以下三条铁律，确保跨平台抽象**不引入任何运行时开销**：

1. **编译时多态，禁止运行时多态**  
   - CHAL接口必须以**C++模板/策略类**或**C结构体函数表（在构建时完全内联）**形式提供。  
   - 禁止使用虚函数、函数指针（除硬件回调外）、运行时架构检测分支。  
   - 架构差异通过**模板特化**或**独立编译单元链接**解决，调用点始终为直接调用或内联。

2. **零间接层**  
   - 任何抽象接口在实例化后，其机器码必须等价于手写的架构特定代码。  
   - 编译器优化（内联、常量传播）必须能够消除所有抽象边界。

3. **硬件特性仅向上暴露**  
   - 不试图“统一”无法统一的能力（如不同MMU的页表格式），而是**统一操作语义**，具体实现由AAL以最直接方式完成。  
   - 例如：不提供跨架构的“页表遍历器”，而是要求AAL实现`map_page`、`unmap_page`、`get_pte`等原语，上层基于这些原语构建策略。

**实施验证**：每次架构移植完成后，必须检查核心调度路径、中断分发路径、域切换路径的反汇编，确保无间接调用、无冗余条件分支。

---

#### 2.1.2 物理内存区域描述符

AAL必须向Core-0提供**物理内存区域列表**，格式如下：

```c
struct mem_region {
    uintptr_t base;      // 物理起始地址
    size_t size;         // 区域大小
    uint32_t type;       // REGULAR, RESERVED, DEVICE, RECLAIMABLE, ...
    uint32_t flags;      // 缓存属性、NUMA节点等
};
```

**实现要求**：
- 在**构建时**通过硬件描述文件（platform.yaml）或**引导时**通过UEFI/设备树/ATAGS生成该列表。
- Core-0的物理页分配器**仅从REGULAR类型区域分配**，其他区域仅用于能力授权（设备内存）或被排除。
- 无MMU变体必须将**整个可用连续空间**视为单个REGULAR区域。

此设计确保分配器不假设全域可用，且**零运行时探测开销**。

---

### 2.2 架构适配层（AAL）

AAL针对不同处理器家族提供优化的实现：

1. **x86-64适配层**
   - 4级/5级页表管理
   - MSR（模型特定寄存器）访问抽象
   - x2APIC/APIC中断控制器接口
   - SMAP/SMEP安全扩展支持

2. **ARMv8-A适配层**
   - 阶段1/阶段2页表（支持虚拟化）
   - 系统寄存器（SCTLR、TCR、MAIR）抽象
   - GICv3/GICv4中断控制器
   - PAN（特权访问从不）和UAO（用户访问覆盖）支持

3. **RISC-V适配层**
   - Sv39/Sv48页表管理
   - PLIC/CLINT中断控制器抽象
   - 特权模式（M/S/U）切换
   - 自定义CSR扩展封装

4. **嵌入式架构适配层**（ARMv7-M、RISC-V Machine模式等）
   - MPU（内存保护单元）管理
   - 简化中断控制器（NVIC）
   - 无MMU内存保护机制

---

### 2.3 隔离机制抽象层（IMAL）

IMAL是HIC实现**方案一（页表静态固化）**与**无MMU变体**统一接口的关键层次。

#### 2.3.1 原语集

```c
// 创建独立隔离域
domain_t *imal_domain_create(void);

// 销毁隔离域
void imal_domain_destroy(domain_t *dom);

// 在域内映射物理内存，设置权限
int imal_map(domain_t *dom, vaddr_t va, paddr_t pa, size_t size, perm_t perm);

// 撤销映射
int imal_unmap(domain_t *dom, vaddr_t va, size_t size);

// 切换当前执行流至目标域（返回后即在新域）
void imal_switch_to(domain_t *dom);

// 全局刷新与域特定刷新
void imal_tlb_flush_all(void);
void imal_tlb_flush_domain(domain_t *dom);
void imal_tlb_flush_va(vaddr_t va);
```

#### 2.3.2 架构变体实现

MMU变体：通过页表实现隔离，`domain_t`指向根页表PA，切换时写TTBR/CR3。
MPU变体：通过MPU区域实现隔离，`domain_t`包含区域配置，切换时重载MPU寄存器。
Safe变体：无硬件隔离，`imal_map`仅记录权限，`imal_switch_to`为空操作，依赖编译器/解释器。

**关键设计**：所有IMAL原语在**调用点静态绑定**到具体变体实现，通过编译时`#ifdef`或模板选择。上层能力系统**完全复用**，不感知底层机制差异。

---

### 2.4 平台特性层（PFL）

PFL封装平台特定的硬件组件：

1. **系统总线与互连**
   - PCIe/PCI枚举与配置空间访问
   - ACPI/设备树解析与抽象
   - SoC内部总线（如AXI、AHB）适配

2. **外设控制器**
   - 统一时钟与电源管理接口
   - DMA引擎抽象
   - GPIO、I2C、SPI等标准外设接口

3. **高级加速器**
   - GPU计算接口抽象
   - 神经网络加速器统一模型
   - 加密引擎硬件抽象

## 3. 构建时的架构选择机制

### 3.1 分层配置系统

HIC采用三层配置模型：

```
应用需求层（用户指定）
    ↓
架构特性层（自动推导）
    ↓
平台约束层（硬件描述）
```

1. **特征驱动配置**：开发者通过高级语义指定需求（如“需要虚拟化支持”、“要求实时性”），构建系统自动选择相应的架构特性和优化。

2. **约束传播**：硬件描述文件（platform.yaml）中的约束（如内存布局、中断控制器类型）向上传播，指导配置选择。

### 3.2 条件编译与模板实例化

HIC使用**静态多态**而非运行时分支来实现跨平台代码：

1. **基于概念的模板**：核心算法（如调度器、能力系统）定义为模板，通过概念（concept）约束接口。

2. **策略类模式**：架构特定的优化策略作为模板参数注入，如：
   ```cpp
   // 伪代码示例
   template<typename MMUPolicy, typename SchedulerPolicy>
   class Core0;
   ```

3. **构建时实例化**：最终的内核映像是为特定硬件**专门实例化**的模板，无运行时架构检测开销。

## 4. 二进制接口标准化

### 4.1 跨架构ABI设计

HIC定义了三层ABI：

1. **内核内部ABI**（KABI）
   - Core-0与Privileged-1服务间的稳定接口
   - 独立于架构，但允许架构优化实现
   - 版本化，支持长期演进

2. **服务间通信ABI**（SCABI）
   - Privileged-1服务间的IPC格式
   - 数据表示（字节序、对齐）标准化
   - 支持自描述消息格式

3. **用户空间ABI**（UABI）
   - 应用与系统间的稳定接口
   - 架构特定的调用约定封装
   - 支持动态链接和版本兼容

### 4.2 数据表示的架构中立性

1. **固定宽度类型**：使用显式宽度整数（uint32_t等），避免架构差异。

2. **字节序透明序列化**：所有跨域消息采用小端字节序，必要时自动转换。

3. **对齐要求抽象**：通过属性标记对齐需求，编译时验证和优化。

## 5. 内存模型统一化

### 5.1 一致性内存视图

HIC通过架构抽象层提供统一的内存模型：

1. **地址空间标识符（ASID）管理**
   - 跨架构统一的ASID分配策略
   - TLB标签位宽的动态适应

2. **缓存一致性抽象**
   - 统一的内存类型（WB/WC/UC）语义
   - 缓存维护操作（清空、无效化）的标准化接口

3. **DMA一致性模型**
   - 设备可访问内存的抽象
   - IOMMU/SMMU的透明使用
   - 缓冲区同步原语

### 5.2 物理内存布局适配

1. **引导时发现**：统一的内核启动协议，支持多种引导标准（UEFI、DTB、ATAGS）。

2. **内存区域规范化**：将平台特定的内存区域（如保留区域、设备内存）映射到标准分类。

3. **NUMA抽象**：统一的多节点内存管理，隐藏架构特定的拓扑差异。

## 6. 中断与异常处理抽象

### 6.1 统一中断模型

HIC定义了一个与架构无关的中断处理框架：

1. **中断描述符**：统一的中断源表示，包含：
   - 中断类型（边缘/电平、消息信号/MSI）
   - 优先级/亲和性信息
   - 处理程序元数据

2. **中断控制器抽象**：统一的编程接口，支持：
   - 中断使能/禁用
   - 优先级配置
   - 亲和性设置
   - EOI（中断结束）操作

3. **嵌套中断处理**：统一的嵌套中断支持，包括：
   - 中断优先级屏蔽
   - 中断栈管理
   - 抢占控制

---

#### 6.1.1 静态中断路由表

HIC中断处理遵循**构建时确定，运行时零查找**原则：

1. **构建时绑定**  
   硬件合成系统解析platform.yaml，为每个中断源指定处理服务及入口点。生成**中断路由表**（架构特定格式）。

2. **运行时安装**  
   CHAL提供`interrupt_install(vector, handler, domain)`，AAL实现为：
   - x86: 写入IDT条目（中断门，DPL=0）
   - ARM: 写入向量表，设置VBAR；对GIC配置中断路由至对应CPU接口
   - RISC-V: 写入mtvec/stvec，对PLIC配置中断使能和优先级

3. **直接分发**  
   中断触发时，硬件直接跳转至**预先安装的处理函数**，该函数入口属于目标Privileged-1服务域。Core-0仅在异常（如非法中断号）时介入。

**性能预期**：从硬件中断信号到服务ISR第一条指令的延迟，在主流架构上**≤1微秒**（含硬件压栈、地址跳转）。

---

### 6.2 异常处理框架

1. **统一异常分类**：将架构特定的异常映射到标准类别（页错误、非法指令、断点等）。

2. **异常上下文抽象**：提供架构无关的异常上下文视图，包括：
   - 通用寄存器快照
   - 错误地址/指令指针
   - 故障原因编码

3. **恢复机制**：标准化的异常恢复协议，支持：
   - 用户态故障的透明处理
   - 内核态服务的优雅降级
   - 硬件错误的隔离与恢复

## 7. 电源管理与功耗控制

### 7.1 跨平台电源状态模型

HIC定义了一组标准电源状态：

1. **CPU电源状态**（C-states）：从C0（活跃）到Cn（深度睡眠）的统一抽象。

2. **设备电源状态**（D-states）：设备特定的低功耗模式标准化。

3. **系统电源状态**（S-states）：S0（开机）到S5（机械关闭）的标准定义。

### 7.2 功耗管理接口

1. **频率/电压调节**：统一的DVFS（动态电压频率调节）接口。

2. **功耗域管理**：抽象的平台功耗域控制。

3. **空闲状态预测**：基于使用模式的智能空闲决策框架。

## 8. 虚拟化支持的可移植抽象

### 8.1 硬件虚拟化统一接口

1. **VM控制结构抽象**：统一VMCS（x86）/VTTBR（ARM）管理。

2. **虚拟异常注入**：架构无关的客户机异常模拟。

3. **影子页表/EPT支持**：二级地址转换的统一管理。

### 8.2 半虚拟化接口

1. **前端/后端协议**：虚拟设备通信的标准协议。

2. **共享内存通信**：虚拟机间通信的零拷贝抽象。

3. **虚拟中断控制器**：跨平台虚拟中断分发。

## 9. 性能监控与调试

### 9.1 统一性能计数器

1. **事件抽象层**：将架构特定的性能事件映射到标准分类（缓存未命中、分支误预测等）。

2. **采样与分析**：跨平台的性能采样基础设施。

3. **性能监控单元（PMU）抽象**：统一的PMU编程接口。

### 9.2 调试支持

1. **硬件断点/观察点**：统一的调试寄存器管理。

2. **跟踪与剖析**：架构无关的指令/数据跟踪。

3. **核心转储格式**：跨平台统一的核心转储格式。

## 10. 安全扩展抽象

### 10.1 硬件安全特性统一

1. **内存加密**：统一的内存加密接口（如AMD SEV、Intel SGX）。

2. **可信执行环境（TEE）**：跨平台TEE抽象（ARM TrustZone、Intel TDX等）。

3. **控制流完整性（CFI）**：硬件CFI支持的标准化。

### 10.2 密码学加速

1. **统一密码学原语**：抽象硬件加速的AES、SHA、RSA等操作。

2. **随机数生成**：跨平台的硬件RNG接口。

3. **密钥管理**：安全的密钥存储与使用抽象。

## 11. 构建与部署工具链

### 11.1 交叉编译支持

1. **工具链抽象**：统一的编译器/链接器接口，支持多工具链。

2. **目标描述文件**：机器可读的目标平台能力描述。

3. **代码生成策略**：根据目标架构自动选择优化策略。

### 11.2 映像生成与打包

1. **多格式支持**：生成适用于不同引导加载程序的内核映像。

2. **模块打包**：跨平台的模块格式（.hicmod）生成。

3. **安全签名**：架构无关的密码学签名验证链。

---

#### 11.2.1 .hicmod多架构布局

为实现二进制模块跨架构部署，.hicmod采用**多段（multi-section）结构**：


.hicmod 文件布局
    模块头：魔数、版本、UUID、签名、架构数量等
    元数据段：名称、描述、依赖、导出端点等（架构中立）
    架构段1：目标架构标识（x86_64）、代码段、数据段、入口偏移
    架构段2：目标架构标识（aarch64）、...
     ...


**加载流程**：
1. 模块管理器读取模块头，获取支持的架构列表。
2. 查询当前平台架构标识，匹配对应架构段。
3. 验证数字签名（对整个模块文件或逐段签名）。
4. 将匹配段的代码和数据加载至新沙箱，执行重定位。
5. 若无匹配架构，拒绝加载。

**优点**：
- **零安装时编译**，适合嵌入式及实时场景。
- **存储开销可控**：一个模块包含2~3种主流架构二进制，体积膨胀约2~3倍，但对现代存储可接受。
- **安全链简化**：签名验证一次完成，无需依赖目标平台编译器。

**未来扩展**：支持**瘦模块**（仅IR）作为备选方案，由构建策略配置。

---

## 12. 测试与验证框架

### 12.1 单元测试可移植性

1. **模拟器层**：轻量级硬件模拟，用于快速测试。

2. **架构仿真**：在QEMU等仿真器上运行完整测试套件。

3. **模糊测试**：跨架构统一的模糊测试框架。

### 12.2 合规性测试

1. **架构一致性测试**：验证HIC实现符合架构规范。

2. **ABI兼容性测试**：确保不同架构间的接口一致性。

3. **性能可移植性测试**：验证性能特征在不同平台上的可预测性。

---

### 12.3 跨架构持续集成与性能门禁

HIC项目实行**架构平等原则**：任何代码提交必须通过**所有主线架构**的功能与性能测试。

**基础设施**：

1. **仿真测试农场**  
   - x86_64: QEMU（完整系统模拟）  
   - ARMv8-A: QEMU（virt平台）  
   - RISC-V: QEMU（sifive_u, virt）  
   - 无MMU: QEMU（arm cortex-m3, riscv32）  

   每次PR自动运行完整内核启动、基础系统调用、服务加载、滚动更新测试。

2. **真实硬件回归集群**  
   - x86: 多代Intel/AMD桌面、服务器  
   - ARM: 树莓派4、鲲鹏920服务器  
   - RISC-V: SiFive HiFive Unmatched、VisionFive  
   - 嵌入式: STM32F4 Discovery（Cortex-M4）  

   每日定时运行完整测试套件，结果上报仪表板。

3. **性能门禁**  
   关键路径（空系统调用、域切换、IPC延迟、中断响应）**性能基准**随提交自动测量，与基线对比。  
   - 若**单次提交性能下降超过5%** → 自动拒绝合并。  
   - 若**趋势性下降（7天平均）** → 标记性能回归。

**可移植性合规徽章**：每个官方支持的架构须通过**架构一致性测试套件**（Architecture Compliance Suite），获得认证徽章，方可标记为“生产就绪”。

---

## 13. 移植路线图与最佳实践

### 13.1 新架构移植步骤

1. **阶段1：CHAL实现** - 实现最小的核心抽象层
2. **阶段2：启动与内存** - 实现引导和基本内存管理
3. **阶段3：中断与异常** - 实现中断和异常处理
4. **阶段4：调度与同步** - 实现多核调度和同步原语
5. **阶段5：设备支持** - 添加平台特定的设备驱动
6. **阶段6：优化** - 架构特定的性能优化

### 13.2 维护与演进

1. **架构回归测试**：每次核心更改都在所有支持架构上测试。

2. **性能回归监测**：持续监测关键路径的性能变化。

3. **ABI稳定性保证**：严格管理接口演进，确保向后兼容。

## 14. 实际案例：从x86-64到ARMv8-A的移植经验

### 14.1 主要差异与应对

1. **内存模型差异**
   - x86：TSO（全存储定序）内存模型
   - ARM：弱内存模型，需要显式屏障
   - 应对：在CHAL中实现架构特定的内存屏障原语

2. **中断处理差异**
   - x86：APIC，基于中断向量
   - ARM：GIC，基于中断号
   - 应对：统一的中断描述符抽象

3. **页表结构差异**
   - x86：4级/5级固定层级
   - ARM：灵活的页表粒度
   - 应对：通用的页表遍历算法

### 14.2 性能调优经验

1. **TLB管理优化**：ARM需要更积极的TLB维护
2. **缓存对齐**：不同架构的缓存行大小差异
3. **分支预测**：架构特定的分支预测器调优

## 15. 未来扩展方向

### 15.1 新兴架构支持

1. **RISC-V扩展**：支持向量扩展（V）、位操作扩展（B）等。
2. **定制加速器**：面向特定领域架构（DSA）的抽象。
3. **异构计算**：CPU+GPU+FPGA的统一管理。

### 15.2 动态可配置性

1. **运行时架构检测**：动态适应不同的微架构特性。
2. **自适应优化**：基于运行时性能特征的自动调优。
3. **混合架构支持**：同一系统内不同架构核心的统一管理。
