# ARM64 架构

## 概述

HIK 支持 ARM64 架构，提供与 x86_64 相同的功能和性能。本文档介绍了 HIK 在 ARM64 架构上的实现细节。

## 架构特性

### CPU 特性

- **特权级**: EL0 (Application-3), EL1 (Core-0/Privileged-1)
- **64位地址空间**: 支持 64 位物理和虚拟地址
- **CNTVCT**: 虚拟计数器定时器用于性能测量
- **SVC**: 超级调用指令用于系统调用

### 寄存器上下文

```c
// ARM64 寄存器上下文
typedef struct arch_context {
    // 通用寄存器 x0-x30
    u64 x[31];
    
    // 特殊寄存器
    u64 sp;               // 栈指针 (x31)
    u64 pc;               // 程序计数器
    u64 pstate;           // 处理器状态
    
    // 系统寄存器
    u64 sp_el0;           // 用户模式栈指针
    u64 elr_el1;          // 异常链接寄存器
    u64 esr_el1;          // 异常综合寄存器
    
    // FP/SIMD 寄存器
    u64 v[32];            // 向量寄存器
    u64 fpsr;             // FP 状态寄存器
    u64 fpcr;             // FP 控制寄存器
} arch_context_t;
```

## 系统调用

### SVC 系统调用

```c
// ARM64 快速系统调用
static inline u64 fast_syscall(u64 num, u64 arg1, u64 arg2, u64 arg3) {
    u64 result;
    __asm__ volatile (
        "svc #0\n"
        : "=r"(result)
        : "r"(num), "r"(arg1), "r"(arg2), "r"(arg3)
        : "memory"
    );
    return result;
}

// 目标: 20-30 ns (60-90 周期 @ 3GHz)
```

## 性能优化

### 虚拟计数器定时器

```c
// 读取虚拟计数器
static inline u64 read_cntvct(void) {
    u64 cnt;
    __asm__ volatile("mrs %0, cntvct_el0" : "=r"(cnt));
    return cnt;
}

// 测量操作延迟
u64 measure_cycles(void (*func)(void)) {
    u64 start = read_cntvct();
    func();
    u64 end = read_cntvct();
    return end - start;
}
```

## 相关文档

- [x86_64 架构](./24-x86_64.md) - x86_64 架构
- [RISC-V 架构](./26-RISC-V.md) - RISC-V 架构
- [快速路径](./19-FastPath.md) - 快速路径优化

---

*最后更新: 2026-02-14*